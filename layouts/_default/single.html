{{ define "main" }}
<!-- Configuración PWA segura inyectada desde GitHub Secrets -->
<script>
{{- $vapidKey := getenv "VAPID_PUBLIC_KEY" -}}
window.PWA_SECURE_CONFIG = window.PWA_SECURE_CONFIG || {};
window.PWA_SECURE_CONFIG.environment = "{{ hugo.Environment }}";
window.PWA_SECURE_CONFIG.buildTime = {{ now.Unix }};
{{ if $vapidKey -}}
window.PWA_SECURE_CONFIG.vapidKey = "{{ $vapidKey }}";
window.PWA_SECURE_CONFIG.hasVapidFromEnv = true;
window.siteConfig = window.siteConfig || {};
window.siteConfig.vapidPublicKey = "{{ $vapidKey }}";
console.log('🔐 VAPID key cargada desde variable de entorno');
{{ else -}}
window.PWA_SECURE_CONFIG.hasVapidFromEnv = false;
// En desarrollo, cargar desde archivo local
fetch('/vapid-config.json')
  .then(response => response.ok ? response.json() : Promise.reject('No config'))
  .then(config => {
    if (config.publicKey) {
      window.siteConfig = window.siteConfig || {};
      window.siteConfig.vapidPublicKey = config.publicKey;
      console.log('🔧 VAPID key cargada desde configuración local');
    }
  })
  .catch(() => {
    console.log('🔧 Modo desarrollo - VAPID key no disponible');
  });
{{ end -}}
</script>

<!-- Script PWA Meta Injector -->
<script src="/js/pwa-meta-injector.js"></script>

<!-- Script de depuración temporal -->
<script src="/js/debug-push.js"></script>

<main class="main" role="main">
    <article class="post">
        {{ if eq .Params.showDate true }}
        <header class="post__header">
            <h1 class="post__title">{{ .Title }}</h1>
            {{- with .Params.lead }}
            <p class="post__lead">{{ . }}</p>
            {{- end }}
            {{ with partial "post_meta.html" . -}}
            <div class="post__meta meta">{{ . }}</div>
            {{- end }}
            {{ $format := "2 Jan 2006 15:04" }}
            <div>Publicado: {{ partial "fecha-es.html" .Date }}</div>
            {{- if .Params.length }}
                <div>Duración: {{ .Params.Length }}</div>
            {{- end }}
        </header>
        {{ end}}
        {{- if .Site.Params.belowTitlePartial }}{{ partial .Site.Params.belowTitlePartial . }}{{ end }}
        {{- if and (.Params.thumbnail) (not .Params.thumbnail_hide_post) }}
        <figure class="post__thumbnail">
            <img src="{{ .Params.thumbnail | relURL }}" alt="{{ .Title }}">
        </figure>
        {{- end }}
        {{- partial "post_toc.html" . -}}
        <div class="content post__content clearfix">
            {{ .Content }}
        </div>
        
        <!-- Social Share Buttons -->
        {{ partial "social-share.html" . }}
        
        {{- if .Params.tags }}
        <footer class="post__footer">
            {{ partial "post_tags.html" . }}
        </footer>
        {{- end }}
    </article>
</main>
{{ partial "authorbox.html" . }}
{{ partial "pager.html" . }}
{{ partial "comments.html" . }}

<!-- Script para funcionalidad de social share -->
{{ partial "social-share-script.html" . }}

{{ end }}