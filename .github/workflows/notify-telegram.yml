# ---
# This workflow sends notifications to Telegram when a new article or podcast is published.
# Automatically detects new articles or podcasts when pushed to the main branch.
# Example message sent:
# üéôÔ∏è Nuevo cap√≠tulo del podcast publicado: Dolphins Podcast Ep. 1
# üîó https://mundodolphins.es/podcast/episodio-1/
# Requires TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets configured in the repository.
# ---

name: üöÄ Notify new articles or podcasts to Telegram

on:
  workflow_run:
    workflows: ["Deploy Hugo site to Pages"]
    types:
      - completed

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: üîÑ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: üîç Detect new articles/podcasts
        id: detect_new
        run: |
          chmod +x scripts/notify/detect_new_articles.sh
          scripts/notify/detect_new_articles.sh

      - name: üì± Send notifications to Telegram
        if: steps.detect_new.outputs.has_new_articles == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          chmod +x scripts/notify/send_to_telegram.sh
          # pass articles.json explicitly; NOTIFICATION_DELAY_SEC can be set in the workflow env if desired
          ./scripts/notify/send_to_telegram.sh articles.json