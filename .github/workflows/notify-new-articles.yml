name: Notify New Articles via FCM

on:
  workflow_run:
    workflows: ["Deploy Hugo site to Pages"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: false
        type: boolean

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 2  # Fetch last 2 commits to compare
    
    - name: üîç Detect new articles
      id: detect_new
      run: |
        chmod +x scripts/notify/detect_new_articles.sh
        scripts/notify/detect_new_articles.sh
    
    - name: üîî Send FCM notifications
      if: steps.detect_new.outputs.has_new_articles == 'true'
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        FCM_TOPIC: ${{ secrets.FCM_TOPIC || 'mundo-dolphins-news' }}
        NOTIFICATION_DELAY_MS: ${{ vars.NOTIFICATION_DELAY_MS || '1000' }}
      run: |
        echo "üîî Sending FCM notifications..."
        npm ci --no-audit --no-fund || npm install --no-audit --no-fund
        node scripts/notify/send_notification.js
        EOF
        node send_notification.js