name: ðŸš€ Notify new Bluesky posts to Telegram

on:
  push:
    branches: [ main ]
    paths:
      - 'data/posts_*.json'

jobs:
  notify-telegram-social:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Detect new social posts
        id: detect_posts
        run: |
          echo "Detecting new social posts..."
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep -E '^data/posts_.*\.json$' || true)
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M HEAD~1 HEAD | grep -E '^data/posts_.*\.json$' || true)
          FILES="$NEW_FILES $MODIFIED_FILES"
          if [ -z "$FILES" ]; then
            echo "No new social posts."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Changed social post files: $FILES"
          echo "has_new_posts=true" >> $GITHUB_OUTPUT
          echo "$FILES" > changed_posts_files.txt

      - name: Cache last published date
        id: cache-date
        uses: actions/cache@v4
        with:
          path: .github/last_bluesky_published.txt
          key: bluesky-last-published

      - name: Send Bluesky posts to Telegram
        if: steps.detect_posts.outputs.has_new_posts == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID environment variables"
            exit 1
          fi
          # Read last published date from cache (if exists)
          LAST_DATE=""
          if [ -f .github/last_bluesky_published.txt ]; then
            LAST_DATE=$(cat .github/last_bluesky_published.txt)
            echo "Last published date from cache: $LAST_DATE"
          fi
          NEW_LAST_DATE="$LAST_DATE"
          for file in $(cat changed_posts_files.txt); do
            echo "Processing $file..."
            jq -c '.[]' "$file" | while read -r post; do
              stype=$(echo "$post" | jq -r '.stype // 1')
              [ "$stype" = "0" ] || continue
              published=$(echo "$post" | jq -r '.PublishedOn // empty')
              text=$(echo "$post" | jq -r '.BlueSkyPost.Description // empty')
              url=$(echo "$post" | jq -r '.BlueSkyPost.BskyPost // empty')
              # Only publish if the date is greater than the last published
              if [ -n "$published" ] && { [ -z "$LAST_DATE" ] || [[ "$published" > "$LAST_DATE" ]]; }; then
                if [ -n "$text" ] && [ -n "$url" ]; then
                  message="${text}\nðŸ”— ${url}"
                  curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                    -d chat_id="$TELEGRAM_CHAT_ID" \
                    -d text="$message" \
                    -d parse_mode="Markdown"
                  # Update the new last date if it's greater
                  if [[ "$published" > "$NEW_LAST_DATE" ]]; then
                    NEW_LAST_DATE="$published"
                  fi
                fi
              fi
            done
          done
          # Save the new last published date to cache
          if [ -n "$NEW_LAST_DATE" ] && [ "$NEW_LAST_DATE" != "$LAST_DATE" ]; then
            echo "$NEW_LAST_DATE" > .github/last_bluesky_published.txt
          fi
